class PredictiveSearch extends SearchForm{constructor(){super(),this.cachedResults={},this.predictiveSearchResults=this.querySelector('[data-predictive-search]'),this.allPredictiveSearchInstances=document.querySelectorAll('predictive-search'),this.isOpen=!1,this.abortController=new AbortController,this.searchTerm='',this.setupEventListeners()}setupEventListeners(){this.input.form.addEventListener('submit',this.onFormSubmit.bind(this)),this.input.addEventListener('focus',this.onFocus.bind(this)),this.addEventListener('focusout',this.onFocusOut.bind(this)),this.addEventListener('keyup',this.onKeyup.bind(this)),this.addEventListener('keydown',this.onKeydown.bind(this))}getQuery(){return this.input.value.trim()}onChange(){super.onChange();const t=this.getQuery();if(!this.searchTerm||!t.startsWith(this.searchTerm))return this.querySelector("#predictive-search-results-groups-wrapper")?.remove();this.updateSearchForTerm(this.searchTerm,t),this.searchTerm=t,0!==this.searchTerm.length&&this.getSearchResults(this.searchTerm)}onFormSubmit(t){this.getQuery().length&&!this.querySelector('[aria-selected="true"] a')&&t.preventDefault()}onFormReset(t){super.onFormReset(t),super.shouldResetForm()&&(this.searchTerm='',this.abortController.abort(),this.abortController=new AbortController,this.closeResults(!0))}onFocus(){const t=this.getQuery();if(!t.length)return;if(this.searchTerm!==t)this.onChange();else if("true"===this.getAttribute('results'))this.open();else{if(this.getSearchResults(this.searchTerm),this.getAttribute('open'))return;this.open()} }onFocusOut(){setTimeout(()=>{this.contains(document.activeElement)||this.close()})}onKeyup(t){if(!this.getQuery().length)return this.close(!0);t.preventDefault();switch(t.code){case 'ArrowUp':this.switchOption('up');break;case 'ArrowDown':this.switchOption('down');break;case 'Enter':this.selectOption()}}onKeydown(t){'ArrowUp'===t.code||'ArrowDown'===t.code&&(t.preventDefault())}updateSearchForTerm(t,e){const i=this.querySelector("[data-predictive-search-search-for-text]"),s=i?.innerText;if(s){if(s.match(new RegExp(e,"g")).length>1)return;const n=s.replace(t,e);i.innerText=n}}switchOption(t){if(this.getAttribute('open')){const e='up'===t,i=this.querySelector('[aria-selected="true"]'),s=Array.from(this.querySelectorAll("li, button.predictive-search__item")).filter((t)=>null!==t.offsetParent),n=0;if(e&&!i)return;let r=-1,a=0;for(;r===-1&&a<=s.length;){if(s[a]===i){r=a;break}a++}this.statusElement.textContent="",e&&(r=0===r?s.length-1:r-1),!e&&i&&(r=r===s.length-1?0:r+1),r!==a&&(i&&(i.setAttribute('aria-selected',!1),this.input.setAttribute('aria-activedescendant','')),s[r].setAttribute('aria-selected',!0),this.input.setAttribute('aria-activedescendant',s[r].id))}}selectOption(){const t=this.querySelector('[aria-selected="true"] a, button[aria-selected="true"]');t&&t.click()}getSearchResults(t){const e=t.replace(" ","-").toLowerCase();this.setLiveRegionLoadingState(),this.cachedResults[e]?this.renderSearchResults(this.cachedResults[e]):fetch(`${routes.predictive_search_url}?q=${encodeURIComponent(t)}&section_id=predictive-search`,{signal:this.abortController.signal}).then((t)=>{if(!t.ok){var e=new Error(t.status);return this.close(),Promise.reject(e)}return t.text()}).then((t)=>{const e=(new DOMParser).parseFromString(t,'text/html').querySelector('#shopify-section-predictive-search').innerHTML;this.allPredictiveSearchInstances.forEach((t)=>{t.cachedResults[e]=e}),this.renderSearchResults(e)}).catch((t)=>{if(t?.code===20)return;this.close(),Promise.reject(t)})}setLiveRegionLoadingState(){this.statusElement=this.statusElement||this.querySelector('.predictive-search-status'),this.loadingText=this.loadingText||this.getAttribute('data-loading-text'),this.setLiveRegionText(this.loadingText),this.setAttribute('loading',!0)}setLiveRegionText(t){this.statusElement.setAttribute('aria-hidden','false'),this.statusElement.textContent=t,setTimeout(()=>{this.statusElement.setAttribute('aria-hidden','true')},1e3)}renderSearchResults(t){this.predictiveSearchResults.innerHTML=t,this.setAttribute('results',!0),this.setLiveRegionResults(),this.open()}setLiveRegionResults(){this.removeAttribute('loading'),this.setLiveRegionText(this.querySelector('[data-predictive-search-live-region-count-value]').textContent)}getResultsMaxHeight(){return this.resultsMaxHeight=window.innerHeight-document.querySelector('.section-header').getBoundingClientRect().bottom,this.resultsMaxHeight}open(){this.predictiveSearchResults.style.maxHeight=this.resultsMaxHeight||`${this.getResultsMaxHeight()}px`,this.setAttribute('open',!0),this.input.setAttribute('aria-expanded',!0),this.isOpen=!0}close(t=!1){this.closeResults(t),this.isOpen=!1}closeResults(t=!1){t&&(this.input.value='',this.removeAttribute('results'));const e=this.querySelector('[aria-selected="true"]');e&&(e.setAttribute('aria-selected',!1),this.input.setAttribute('aria-activedescendant',''),this.removeAttribute('loading'),this.removeAttribute('open'),this.input.setAttribute('aria-expanded',!1),this.resultsMaxHeight=!1,this.predictiveSearchResults.removeAttribute('style'))}}customElements.define('predictive-search',PredictiveSearch);
